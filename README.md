# Лабораторная работа №9: Оптимизация образов контейнеров

## Цель работы

Ознакомиться с методами оптимизации Docker-образов: удаление временных файлов, уменьшение слоёв, выбор минимального основного образа, перепаковка образов.

---

## Задание

Сравнить различные методы оптимизации образов:

- Удаление неиспользуемых зависимостей и временных файлов
- Уменьшение количества слоев
- Минимальный базовый образ
- Перепаковка образа
- Использование всех методов

---

## Ход работы

### 1. Клонирован пустой Git-репозиторий `containers09`

```bash
git clone git@github.com:iurii1801/containers09.git
```

![image](https://i.imgur.com/euS4Qhr.png)

### 2. В папке `containers09` создана папка `site` и перемещены в неё файлы сайта (`html`, `css`, `js`)

![image](https://i.imgur.com/qrgNqqI.png)

![image](https://i.imgur.com/gkRVbnV.png)

### 3. Создание и наполнение файла `Dockerfile.raw` с инструкциями для базовой сборки контейнера `Nginx` без оптимизации

- **Создан `Dockerfile.raw`:**

```powershell
New-Item -Name "Dockerfile.raw" -ItemType "File"
```

![image](https://i.imgur.com/89ZcGty.png)

Это создаёт пустой файл `Dockerfile.raw` в директории `containers09`. Он будет содержать инструкции для базовой сборки `Docker-образа` с `Nginx` на основе `Ubuntu` без какой-либо оптимизации.

- **Срдержимое:**

```dockerfile
# create from ubuntu image
FROM ubuntu:latest

# update system
RUN apt-get update && apt-get upgrade -y

# install nginx
RUN apt-get install -y nginx

# copy site
COPY site /var/www/html

# expose port 80
EXPOSE 80

# run nginx
CMD ["nginx", "-g", "daemon off;"]
```

![image](https://i.imgur.com/vJDh81a.png)

Файл `Dockerfile.raw` представляет собой базовую версию инструкции сборки Docker-образа, основанную на полном образе `ubuntu:latest`. В этом Dockerfile все шаги выполняются отдельно: сначала происходит обновление системы, затем установка веб-сервера Nginx, далее в контейнер копируются файлы сайта из локальной директории `site/`, открывается 80-й порт, и указывается команда запуска Nginx. Данный подход логически разделяет этапы, что может быть удобно при отладке, но в то же время создаёт множество промежуточных слоёв и не удаляет кэш или временные файлы. Это приводит к тому, что финальный образ получается большим по размеру. Именно этот Dockerfile используется в лабораторной работе как отправная точка для анализа и последующей оптимизации.

- ***Сборка `Docker-образа mynginx:raw` из файла `Dockerfile.raw`**

```powershell
docker image build -t mynginx:raw -f Dockerfile.raw .
```

![image](https://i.imgur.com/6np9as3.png)

- **Проверка размера образа `mynginx:raw` после сборки**

```powershell
docker image list
```

![image](https://i.imgur.com/UgNxd9K.png)

В таблице указаны их теги (`TAG`), идентификаторы (`IMAGE ID`), время создания (`CREATED`) и размер (`SIZE`).

В верхней строке видно, что образ `mynginx` с тегом `raw` был создан недавно (36 seconds ago) и занимает 241MB. Это подтверждает, что не оптимизированный образ достаточно тяжёлый, поскольку:

1. использован базовый образ `ubuntu:latest`

2. каждая команда создаёт отдельный слой

3. не были удалены временные файлы и кэш `apt`

Эта информация послужит отправной точкой для сравнения с оптимизированными версиями образов, создаваемыми в следующих шагах.

### 4. Создание файла `Dockerfile.clean` для образа с очисткой кэша

```powershell
New-Item -Name "Dockerfile.clean" -ItemType "File"
```

![image](https://i.imgur.com/Lv3Pof4.png)

Эта команда создаёт новый пустой файл `Dockerfile.clean` в директории `containers09`. В дальнейшем в этот файл будут добавлены инструкции для сборки Docker-образа, аналогичного raw, но с добавлением команды очистки кэша и временных файлов, чтобы уменьшить размер итогового образа.

Этот шаг закладывает основу для первой стадии оптимизации Docker-образа.

- **Содержимое:**

```powershell
# create from ubuntu image
FROM ubuntu:latest

# update system
RUN apt-get update && apt-get upgrade -y

# install nginx
RUN apt-get install -y nginx

# remove apt cache
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# copy site
COPY site /var/www/html

# expose port 80
EXPOSE 80

# run nginx
CMD ["nginx", "-g", "daemon off;"]
```

![image](https://i.imgur.com/eRw0Pi4.png)

`Dockerfile.clean` представляет собой улучшенную версию предыдущего файла. В нём добавлена очистка кэша менеджера пакетов `apt`, а также удаление временных директорий после завершения установки. Это достигается добавлением отдельной инструкции `RUN apt-get clean && rm -rf ...`. Однако, несмотря на наличие этих команд, оптимизация в этом Dockerfile неэффективна. Причина в том, что каждая команда RUN создаёт новый слой, и если очистка выполняется в отдельной инструкции, то кэшированные данные из предыдущих слоёв всё равно сохраняются в истории сборки образа. Таким образом, даже при удалении временных файлов, размер итогового образа почти не уменьшается. Этот Dockerfile используется для иллюстрации важности правильного размещения команд очистки внутри одной инструкции.

- **Сборка оптимизированного образа `mynginx:clean` с удалением кэша**

```powershell
docker image build -t mynginx:clean -f Dockerfile.clean .
```

![image](https://i.imgur.com/xN2qpKl.png)

- **Сравнение размеров образов: `raw` и `clean`**

```powershell
docker image list
```

![image](https://i.imgur.com/RIOG6yJ.png)

- На этом этапе сравниваются размеры исходного (`mynginx:raw`) и оптимизированного (`mynginx:clean`) образов.

Что видно:

1. `mynginx:raw` и `mynginx:clean` оба занимают по 241MB, несмотря на то что во втором Dockerfile была добавлена очистка кэша (apt-get clean, rm -rf /tmp/* и др.).

2. Это подтверждает важный вывод: если очистка выполняется в отдельной инструкции RUN, то размер образа почти не изменяется, так как предыдущие слои (включая кэш) всё равно остаются в истории сборки.

***Вывод:***
Для эффективной оптимизации необходимо объединять очистку с установкой пакетов в одну инструкцию RUN, как это будет сделано в следующем Dockerfile (few).

### 5. Создание файла `Dockerfile.few`

```powershell
New-Item -Name "Dockerfile.few" -ItemType "File"
```

![image](https://i.imgur.com/3BeYdxp.png)

Этот файл предназначен для хранения Docker-инструкций сборки оптимизированного образа, в котором установка пакетов и удаление временных данных выполняются в одной команде `RUN`. Это позволяет сократить количество слоёв образа и уменьшить его итоговый размер, в отличие от предыдущего Dockerfile с отдельными инструкциями.

- **Содержимое:**

```powershell
# create from ubuntu image
FROM ubuntu:latest

# update system, install nginx, clean everything — all in one RUN
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y nginx && \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# copy site
COPY site /var/www/html

# expose port 80
EXPOSE 80

# run nginx
CMD ["nginx", "-g", "daemon off;"]
```

![image](https://i.imgur.com/uzqucJe.png)

`Dockerfile.few` устраняет недостаток предыдущей версии. Все команды, связанные с обновлением системы, установкой Nginx и последующей очисткой, объединены в одну инструкцию `RUN`. Это позволяет Docker’у сохранить в образе только конечное состояние файловой системы, без промежуточных слоёв, содержащих временные и ненужные файлы. Такой подход значительно уменьшает итоговый размер образа. В лабораторной работе этот Dockerfile демонстрирует эффективную практику оптимизации путём сокращения количества слоёв и удаления кэша непосредственно в процессе установки. Это уже первый шаг к созданию действительно минимального и производительного контейнера.

- **Сборка образа `mynginx:few` из `Dockerfile.few`**

```powershell
docker image build -t mynginx:few -f Dockerfile.few .
```

![image](https://i.imgur.com/FndaxVZ.png)

- **Сравнение размеров образов после сборки `mynginx:few`**

```powershell
docker image list
```

![image](https://i.imgur.com/IXPKdp7.png)

Список отображает все образы, хранящиеся в локальном реестре `Docker`. Здесь видны три ключевых образа проекта:

`mynginx:raw` — 241MB
Базовый образ без оптимизации, построен на `ubuntu:latest` с множеством отдельных слоёв и без очистки кэша.

`mynginx:clean` — 241MB
Несмотря на добавленную очистку `apt-get clean` и `rm -rf`, она выполнена в отдельной инструкции RUN, и кэш сохраняется в предыдущих слоях.

`mynginx:few` — 192MB
Здесь команды установки и очистки объединены в один `RUN`. Это позволяет `Docker` выбросить промежуточные данные, сократив размер почти на 50MB.

***Вывод:*** 
Реальная экономия достигается только в том случае, если установка и удаление лишних файлов выполняются в одной инструкции `RUN`, иначе ненужные данные всё равно сохраняются внутри образа в истории слоёв.